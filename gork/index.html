<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF=8">
    <link rel="stylesheet" href="gork.css">
    <script src="commands.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-firestore.js"></script>
    <script src="gork_firebase.js"></script>

    <script type="text/javascript">
        var LOCATION_KEY = "current_location";


        var dbase = firebase.firestore();
        var db_gork = dbase.collection("gork");
        var db_locs = db_gork.doc("locations");


        function getCookie(name) {
            let cookie = {};
            document.cookie.split(';').forEach(function(el) {
                let [k,v] = el.split('=');
                cookie[k.trim()] = v;
            })
          return cookie[name];
        }

        function getLocation() {
            return getCookie(LOCATION_KEY);
        }

    	function getCurrentText() {
    		var curText = document.getElementById('output').textContent;

    		// note that there's roughly 32 newlines worth of space I want to accommodate
    		var i = 0;
    		var index = -1;
    		var tmpIndex = -1;
    		while (i < 34) {
    			var startPos = index == -1 ? curText.length : index - 1;
    			tmpIndex = curText.lastIndexOf("\n", startPos);
    			if (tmpIndex == -1 && index == -1)
    				return curText;
    			else
    				index = tmpIndex;
    			if (tmpIndex == -1)
    				break;
    			++i;
    		}
    		return curText.substr(-1 * (curText.length - index));
    	}

        function parseAndAddDescription(desc, output) {
            var bracketExp = /<([^>]+)>([^<]*)/;
            var match = bracketExp.exec(desc);
            output.appendChild(document.createTextNode(match[2]));
        }

        function testInput() {
        	var cmd = document.getElementById("cli").value;
            var cmds = cmd.split(" ");
        	var appendText = "$" + cmd + "\n";
           	var curText = getCurrentText();


            var output = document.getElementById("output");
            output.textContent = "";
            output.appendChild(document.createTextNode("$ " + cmd + "\n"));

            if (!cmdHash.hasOwnProperty(cmds[0])) {
            	output.appendChild(document.createTextNode("I'm not sure what you mean by \"" + cmd + "\".\n\n"));
            }

            // DO STUFF WITH COMMAND

            var locations = db_gork.doc("locations");

            locations.get().then(function(doc) {
                if (doc.exists) {
                    parseAndAddDescription(doc.data()["0,0"]["description"], output);
                }
                else {
                    console.log("No such document.");
                }
            }).catch(function(error) {
                console.log("Error getting document: ", error);
            });


            // UPDATE LOCATION
            /*
            var locationVal = LOCATION_KEY + "=COOOOKIE" + cmd;
            document.cookie = locationVal;

            console.log(getLocation());
            */
        }

        function focusTextField() {
        	document.getElementById('cli').focus();
        }
    </script>

</head>
<body onload="focusTextField()" onfocus="focusTextField()">
    <table class="outerTextBox">
    	<tr>
    		<td>&nbsp;</td>
    		<td colspan="2" class="output">
    			<div name="output" id="output"></div>
    		</td>
    	</tr>
    	<tr height=20>
    		<td width=10>&nbsp;</td>
    		<td width=10>$</td>
    		<td>
    			<form onsubmit="testInput();return false;">
    				<input type="text" name="cli" id="cli" width=100% />
    			</form>
    		</td>
    	</tr>
    	<tr height=10>
    		<td>&nbsp;</td>
    		<td>&nbsp;</td>
    		<td>&nbsp;</td>
    	</tr>
    </table>
</body>
</html>